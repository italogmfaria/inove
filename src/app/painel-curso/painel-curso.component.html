<body>
    <div class="background-decoration">
        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
        <div class="circle circle-3"></div>
    </div>

    <div class="curso-container">
        <header class="header">
            <button class="back-btn" (click)="goBack()">
                <span class="material-icons">arrow_back</span>
                <span class="back-text">Voltar</span>
            </button>
            <img src="assets/logowhite.png" (click)="navigateTo('/cursos')" alt="Logotipo INOVE" class="logo">
            <button class="profile-btn" (click)="navigateTo('/perfil-usuario')">
                <span class="material-icons">person</span>
                <span>Perfil</span>
            </button>
        </header>

        <div class="main-wrapper">
            <div class="course-title-section">
                <h1 class="course-title">{{ courseTitle }}</h1>
            </div>

            <div class="content-grid">
                <div class="viewer-card">
                    <div class="viewer" *ngIf="currentContentUrl">
                        <div class="loading-spinner" *ngIf="isContentLoading">
                            <div class="spinner"></div>
                            <p>Carregando conteúdo...</p>
                        </div>

                        <!-- Video Player Customizado -->
                        <app-video-player
                          *ngIf="currentContentUrl.toString().toLowerCase().endsWith('.mp4') && !isContentLoading"
                          [videoUrl]="currentContentUrl"
                          (loadeddata)="onContentLoaded()">
                        </app-video-player>

                        <div class="pdf-container" *ngIf="currentContentUrl.toString().toLowerCase().endsWith('.pdf') && !isContentLoading">
                            <pdf-viewer class="pdf-area"
                                        [src]="currentContentUrl"
                                        [render-text]="true">
                            </pdf-viewer>
                        </div>
                    </div>

                    <div class="empty-viewer" *ngIf="!currentContentUrl">
                        <span class="material-icons empty-icon">play_circle_outline</span>
                        <h3>Nenhum conteúdo selecionado</h3>
                        <p>Selecione um vídeo ou PDF no conteúdo do curso para começar</p>
                    </div>
                </div>

                <aside class="content-panel">
                    <div class="panel-header">
                        <span class="material-icons">list</span>
                        <h2>Conteúdo do Curso</h2>
                    </div>

                    <div class="sections-list" *ngIf="sections && sections.length > 0">
                        <div class="section" *ngFor="let section of sections; let i = index">
                            <button class="section-toggle" (click)="toggleSection(i)">
                                <span class="material-icons section-icon">folder</span>
                                <span class="section-title">{{ section.title }}</span>
                                <span class="material-icons toggle-icon">{{ section.isOpen ? 'expand_less' : 'expand_more' }}</span>
                            </button>

                            <ul class="contents-list" *ngIf="section.isOpen">
                                <li *ngFor="let content of section.contents" class="content-item">
                                    <button class="content-btn" (click)="changeContent(content)">
                                        <span class="material-icons content-type-icon">
                                            {{ content.contentType === 'VIDEO' ? 'play_circle' : 'picture_as_pdf' }}
                                        </span>
                                        <span class="content-title">{{ content.title }}</span>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="empty-content-panel" *ngIf="!sections || sections.length === 0">
                        <span class="material-icons empty-content-icon">folder_open</span>
                        <h3>Nenhum conteúdo disponível</h3>
                        <p>Este curso ainda não possui seções ou conteúdos cadastrados.</p>
                    </div>
                </aside>
            </div>

            <div class="course-info-card">
                <div class="info-header">
                    <span class="material-icons">info</span>
                    <h3>Informações do Curso</h3>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="material-icons">description</span>
                        <div>
                            <strong>Descrição</strong>
                            <p>{{ description }}</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="material-icons">person</span>
                        <div>
                            <strong>Instrutor</strong>
                            <p>{{ instructor }}</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="material-icons">calendar_today</span>
                        <div>
                            <strong>Data de Criação</strong>
                            <p>{{ courseCreationDate | date: 'dd/MM/yyyy' }}</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="material-icons">update</span>
                        <div>
                            <strong>Última Atualização</strong>
                            <p>{{ lastUpdateDate | date: 'dd/MM/yyyy' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <section class="comments-section">
                <div class="comments-header">
                    <span class="material-icons">chat_bubble</span>
                    <h2>Feedbacks</h2>
                    <span class="comments-count" *ngIf="course && course.feedBacks">({{ course.feedBacks.length }})</span>
                </div>

                <div class="user-comment-section">
                    <div *ngIf="userFeedback && !isEditing" class="existing-comment">
                        <div class="comment-header-edit">
                            <span class="material-icons">edit_note</span>
                            <strong>Seu feedback:</strong>
                        </div>
                        <p>{{ userFeedback.comment }}</p>
                        <div class="comment-actions">
                            <button class="btn-edit" (click)="enableEdit()">
                                <span class="material-icons">edit</span>
                                Editar
                            </button>
                            <button class="btn-delete" (click)="deleteFeedback()">
                                <span class="material-icons">delete</span>
                                Excluir
                            </button>
                        </div>
                    </div>

                    <div *ngIf="!userFeedback && !isEditing" class="add-comment-prompt">
                        <button class="btn-add-comment" (click)="isEditing = true">
                            <span class="material-icons">add_comment</span>
                            Adicionar Feedback
                        </button>
                    </div>

                    <div *ngIf="isEditing" class="comment-box">
                        <div class="textarea-wrapper">
                            <span class="material-icons textarea-icon">edit</span>
                            <textarea [(ngModel)]="newComment"
                                      placeholder="Escreva seu feedback sobre o curso..."
                                      rows="4"></textarea>
                        </div>
                        <div class="comment-box-actions">
                            <button class="btn-submit" (click)="addOrUpdateFeedback()" [disabled]="!newComment.trim()">
                                <span class="material-icons">send</span>
                                {{ userFeedback ? 'Atualizar' : 'Enviar' }}
                            </button>
                            <button class="btn-cancel" (click)="cancelEdit()">
                                <span class="material-icons">close</span>
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="comments-list" *ngIf="course && course.feedBacks && course.feedBacks.length > 0">
                    <div class="comment" *ngFor="let feedback of course.feedBacks; let i = index"
                         [style.animation-delay]="(i * 0.1) + 's'">
                        <div class="comment-avatar">
                            <span class="material-icons">account_circle</span>
                        </div>
                        <div class="comment-content">
                            <p class="comment-user">{{ feedback.student.name }}</p>
                            <p class="comment-text">{{ feedback.comment }}</p>
                        </div>
                    </div>
                </div>

                <div class="empty-comments" *ngIf="!course || !course.feedBacks || course.feedBacks.length === 0">
                    <span class="material-icons">rate_review</span>
                    <p>Nenhum feedback ainda. Seja o primeiro!</p>
                </div>
            </section>
        </div>
    </div>

    <div class="modal-overlay" *ngIf="showConfirmModal" (click)="cancelConfirmation()">
        <div class="modal confirm-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div class="confirm-icon delete">
                    <span class="material-icons">warning</span>
                </div>
            </div>

            <div class="confirm-content">
                <h2>Excluir Feedback</h2>
                <p>Tem certeza que deseja excluir seu feedback? Esta ação não pode ser desfeita.</p>
            </div>

            <div class="confirm-actions">
                <button class="btn-cancel" (click)="cancelConfirmation()">
                    <span class="material-icons">close</span>
                    <span>Cancelar</span>
                </button>
                <button class="btn-confirm delete" (click)="confirmAction()">
                    <span class="material-icons">delete_forever</span>
                    <span>Excluir</span>
                </button>
            </div>
        </div>
    </div>
</body>
